#!/bin/bash

# Mahakaal OS - GitHub Repository Sync Script
# Usage: sync-my-repos [username]

USERNAME=${1:-"harsh1991mishra"}
TARGET_DIR="$HOME/Github/repos"

echo -e "\e[1;36m[Mahakaal OS] Starting GitHub Repository Sync for user: $USERNAME\e[0m"

# Create target directory
mkdir -p "$TARGET_DIR"
cd "$TARGET_DIR"

# Function to sync a single repo url
sync_repo() {
    local url=$1
    local name=$(basename "$url" .git)
    if [ -d "$name" ]; then
        echo -e "\e[1;33mSyncing $name...\e[0m"
        (cd "$name" && git pull -q)
    else
        echo -e "\e[1;32mCloning $name...\e[0m"
        git clone -q "$url"
    fi
}

# Check authentication for GH CLI
if gh auth status &> /dev/null; then
    echo -e "\e[1;32mAuthenticated with GitHub. Fetching ALL (Public + Private) repositories...\e[0m"
    # Fetch repos (limit 1000) using gh
    gh repo list "$USERNAME" --limit 1000 --json cloneUrl --template '{{range .}}{{printf "%s\n" .cloneUrl}}{{end}}' | while read -r url; do
        sync_repo "$url"
    done
else
    echo -e "\e[1;33m[!] Warning: You are not logged in to GitHub.\e[0m"
    echo "To fetch PRIVATE repositories, run: gh auth login"
    echo "Fetching PUBLIC repositories only (via API)..."
    
    if ! command -v jq &> /dev/null; then
        echo "Error: 'jq' is missing. Please install it with 'sudo apt install jq'."
        exit 1
    fi

    # API Pagination Loop
    page=1
    while true; do
        echo -e "\e[1;30mFetching page $page...\e[0m"
        response=$(curl -s "https://api.github.com/users/$USERNAME/repos?per_page=100&type=all&page=$page")
        
        # Check if response is empty array or error
        count=$(echo "$response" | jq '. | length')
        if [ "$count" -eq 0 ]; then
            break
        fi

        # Process URLs
        echo "$response" | jq -r '.[].clone_url' | while read url; do
            sync_repo "$url"
        done

        ((page++))
    done
fi

echo -e "\e[1;36m[Mahakaal OS] All repositories synced to $TARGET_DIR\e[0m"
